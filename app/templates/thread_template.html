<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>掲示板 - スレッド</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1 id="threadTitle">掲示板 - スレッド</h1>
    <form id="postForm">
        <input type="text" id="content" placeholder="投稿内容" required>
        <button type="submit">投稿</button>
    </form>
    <div id="posts"></div>

    <script>
        const threadId = "{{ thread_id }}";

        document.getElementById('postForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const content = document.getElementById('content').value;
            fetch('/add', {
                method: 'POST',
                body: new URLSearchParams({'content': content, 'thread_id': threadId}),
                headers: {'Content-Type': 'application/x-www-form-urlencoded'}
            }).then(response => response.json()).then(data => {
                if (data.result === 'success') {
                    loadPosts();
                    document.getElementById('content').value = '';
                }
            });
        });

        // ページが読み込まれた時に既存の投稿を取得して表示する
        window.onload = function() {
            loadPosts();
        }

        function loadPosts() {
            fetch(`/posts/${threadId}`, {
                method: 'GET'
            }).then(response => response.json()).then(data => {
                const postsDiv = document.getElementById('posts');
                postsDiv.innerHTML = '';
                data.forEach(post => {
                    const postDiv = document.createElement('div');
                    postDiv.className = 'post';
                    postDiv.innerHTML = `<strong>${post.id}</strong> ${formatDate(post.timestamp)}:<br>${convertToLinks(post.content)}`;
                    postsDiv.appendChild(postDiv);
                });
            });
        }

        // 日付を希望のフォーマットに変換する関数
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
        }

        // リンクをハイパーリンクに変換する関数
        function convertToLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
        }
    </script>
</body>
</html>
